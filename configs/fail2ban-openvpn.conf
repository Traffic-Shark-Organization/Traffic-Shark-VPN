# Fail2Ban configuration for OpenVPN
# Защита от брутфорса и подозрительной активности

[openvpn]

# Включить jail
enabled = true

# Порт для блокировки (может быть несколько: 1194,443)
port    = 1194

# Протокол
protocol = udp

# Фильтр для обнаружения атак
filter  = openvpn

# Путь к лог-файлу OpenVPN
logpath = /var/log/openvpn/openvpn.log
          /var/log/openvpn.log
          %(syslog_daemon)s

# Backend для чтения логов
# auto, pyinotify, gamin, polling, systemd
backend = auto

# Максимальное количество попыток до бана
maxretry = 3

# Время окна для подсчета попыток (секунды)
# 600 секунд = 10 минут
findtime = 600

# Время бана (секунды)
# 3600 секунд = 1 час
bantime = 3600

# Для повторных нарушений увеличивать время бана
# Каждый последующий бан увеличивается в 2 раза
bantime.increment = true
bantime.factor = 2
bantime.multipliers = 1 2 4 8 16 32 64

# Максимальное время бана (7 дней)
bantime.maxtime = 604800

# Action при обнаружении атаки
# iptables-allports - блокировать все порты для IP
# iptables-multiport - блокировать только указанные порты
action = iptables-allports[name=openvpn, protocol=udp]
         sendmail-whois[name=openvpn, dest=admin@trafficshark.local]

# Альтернативные actions:
# action = %(action_mw)s  # ban + отправка email с whois
# action = %(action_mwl)s # ban + email с whois и логами

# Игнорировать локальные IP
ignoreip = 127.0.0.1/8
           ::1
           10.8.0.0/24

# Regex для поиска неудачных попыток аутентификации
# Дополнительно к стандартному фильтру

##############################################
# Дополнительные параметры
##############################################

# Использовать DNS для резолва имен в action
usedns = warn

# Режим бана
# normal - стандартный бан
# aggressive - более агрессивный (меньше попыток)
banaction = iptables-multiport

# Режим работы с цепочками iptables
chain = INPUT

##############################################
# Кастомный фильтр (если нужен)
##############################################

# Если стандартный фильтр не подходит, создайте свой:
# /etc/fail2ban/filter.d/openvpn-custom.conf

##############################################
# Примечания
##############################################

# 1. Проверка статуса:
#    fail2ban-client status openvpn
#
# 2. Просмотр заблокированных IP:
#    fail2ban-client get openvpn banip
#
# 3. Разблокировка IP:
#    fail2ban-client set openvpn unbanip <IP>
#
# 4. Перезагрузка конфигурации:
#    systemctl restart fail2ban
#
# 5. Тестирование фильтра:
#    fail2ban-regex /var/log/openvpn/openvpn.log /etc/fail2ban/filter.d/openvpn.conf
#
# 6. Просмотр логов fail2ban:
#    tail -f /var/log/fail2ban.log
#
# 7. Список всех jail:
#    fail2ban-client status

