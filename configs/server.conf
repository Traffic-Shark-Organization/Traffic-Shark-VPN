# OpenVPN Server Configuration
# Для корпоративного VPN на 50+ клиентов
# Версия: 1.0.0

#################################################
# Основные параметры сервера
#################################################

# Порт и протокол
port 1194
proto udp

# Тип устройства - routed VPN (более эффективно чем bridged)
dev tun

#################################################
# SSL/TLS параметры
#################################################

# CA сертификат
ca /etc/openvpn/ca.crt

# Серверный сертификат и ключ
cert /etc/openvpn/server.crt
key /etc/openvpn/server.key

# Diffie-Hellman параметры (4096 bit для максимальной безопасности)
dh /etc/openvpn/dh.pem

# TLS Authentication для защиты от:
# - DoS атак
# - Port scanning
# - Buffer overflow уязвимостей
# Direction 0 = сервер, 1 = клиент
tls-auth /etc/openvpn/ta.key 0

# TLS настройки
# Минимальная версия TLS 1.3 (максимальная безопасность)
tls-version-min 1.3

# Современные cipher suites
tls-cipher TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384:TLS-ECDHE-ECDSA-WITH-AES-256-GCM-SHA384

# Data channel шифрование
# AES-256-GCM - modern AEAD cipher, рекомендован для OpenVPN 2.4+
cipher AES-256-GCM

# HMAC аутентификация
auth SHA512

# Отключение устаревших алгоритмов
tls-ciphersuites TLS_AES_256_GCM_SHA384

#################################################
# Сетевые настройки
#################################################

# VPN подсеть для клиентов
# 10.8.0.0/24 позволяет подключить до 254 клиентов
server 10.8.0.0 255.255.255.0

# Topology subnet - современная топология (рекомендуется)
topology subnet

# Сохранение таблицы IP адресов между перезапусками
ifconfig-pool-persist /var/log/openvpn/ipp.txt

# Push маршрутов клиентам
# Редирект всего трафика через VPN (full-tunnel)
push "redirect-gateway def1 bypass-dhcp"

# DNS серверы для клиентов
# Cloudflare DNS (безопасные и быстрые)
push "dhcp-option DNS 1.1.1.1"
push "dhcp-option DNS 1.0.0.1"

# Альтернатива - Google DNS
# push "dhcp-option DNS 8.8.8.8"
# push "dhcp-option DNS 8.8.4.4"

# Разрешить клиентам видеть друг друга
# ВАЖНО: закомментируйте, если не нужна peer-to-peer связь
client-to-client

#################################################
# Производительность и оптимизация
#################################################

# Максимальное количество клиентов
max-clients 100

# Keepalive: проверка соединения каждые 10 сек, таймаут через 120 сек
keepalive 10 120

# Размеры буферов для оптимизации производительности
# 393216 bytes = 384 KB
sndbuf 393216
rcvbuf 393216

# Push настройки буфера клиентам
push "sndbuf 393216"
push "rcvbuf 393216"

# Fast I/O (минимизация переключения контекста)
fast-io

# Отключение compression (безопасность > производительность)
# VORACLE и CRIME атаки эксплуатируют compression
compress migrate
push "compress migrate"

#################################################
# Безопасность и привилегии
#################################################

# Запуск процесса от непривилегированного пользователя после инициализации
user nobody
group nogroup

# Сохранение состояния при понижении привилегий
persist-key
persist-tun

# CRL (Certificate Revocation List) для отзыва скомпрометированных сертификатов
crl-verify /etc/openvpn/crl.pem

# Запрет дублирующихся Common Names (один сертификат = одно соединение)
# Закомментируйте, если нужны множественные подключения с одного сертификата
duplicate-cn

# Дополнительные проверки безопасности
remote-cert-tls client

# Защита от replay атак
replay-window 64 15

#################################################
# Логирование и мониторинг
#################################################

# Уровень детализации логов
# 0 - минимум (только критичные ошибки)
# 3 - рекомендуемый (стандартная информация)
# 5-9 - отладка (очень подробно)
verb 3

# Ограничение повторяющихся сообщений
mute 20

# Файл статуса подключенных клиентов
# Обновляется каждую секунду
status /var/log/openvpn/openvpn-status.log 1

# Файл логов (детальная информация)
log-append /var/log/openvpn/openvpn.log

# Management interface для мониторинга (опционально)
# management localhost 7505

#################################################
# Скрипты и хуки
#################################################

# Скрипты выполняются при подключении/отключении клиента
# Раскомментируйте при необходимости

# script-security 2
# client-connect /etc/openvpn/scripts/client-connect.sh
# client-disconnect /etc/openvpn/scripts/client-disconnect.sh

# Проверка пользователя/пароля (опционально)
# auth-user-pass-verify /etc/openvpn/scripts/verify.sh via-env

#################################################
# Дополнительные параметры безопасности
#################################################

# Отключение renegotiation (предотвращение некоторых атак)
reneg-sec 0

# Таймаут TLS handshake
tls-timeout 120

# Максимальное количество байт/пакетов до renegotiation
# explicit-exit-notify 1

#################################################
# IPv6 поддержка (опционально)
#################################################

# Раскомментируйте для включения IPv6
# server-ipv6 fd00::/64
# push "route-ipv6 2000::/3"
# tun-ipv6

#################################################
# Производительность: туннелирование TCP через UDP
#################################################

# Не используйте TCP over TCP (performance degradation)
# Если нужен TCP, создайте отдельный конфиг на порту 443

#################################################
# Примечания
#################################################

# 1. Для изменений конфигурации требуется перезапуск:
#    systemctl restart openvpn@server
#
# 2. Проверка конфигурации:
#    openvpn --config /etc/openvpn/server.conf --test-crypto
#
# 3. Просмотр подключенных клиентов:
#    cat /var/log/openvpn/openvpn-status.log
#
# 4. Мониторинг логов в реальном времени:
#    tail -f /var/log/openvpn/openvpn.log
#
# 5. Для production обязательно настройте CRL:
#    crl-verify /etc/openvpn/crl.pem

